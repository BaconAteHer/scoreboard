<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<!--
# MIT License
#
# Copyright (c) 2018-2019 Jakob "Bacon Ate Her" Kaivo <bacon@ateher.com>
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
-->

<title>Scoreboard</title>
<style type="text/css">
#editTeams {
	display: none;
	position: fixed;
	left: 25%;
	width: 50%;
	height: 75%;
	top: 12.5%;
	background: darkgray;
}

table {
	margin-left: auto;
	margin-right: auto;
}

td input[type=text] {
	background: white;
	color: black;
}

td.number, td.number input[type=text] {
	width: 4em;
}

td.name {
	text-align: left;
}

.control {
	display: inline;
}

body {
	top: 0;
	left: 0;
	width: 95%;
	height: 100%;
	background: lightgray;
	color: black;
	padding: 1em;
	text-align: center;
}

.timeoutsAndScore {
	background: white;
	color: black;
	border-radius: .5em;
	margin-bottom: 1em;
	padding-bottom: 1em;
}

.timeouts {
	width: 1em;
	display: inline;
}

#team1, #team2, #period, #jam {
	display: inline-block;
	width: 45%;
}

#team1, #period {
	float: left;
}

#team2, #jam {
	float: right;
}

#timing {
	width: 95%;
	position: absolute;
	clear: both;
	bottom: 0;
	padding: 0;
}

#timing h2 {
	background: white;
	color: black;
	margin: 0;
	border-radius: .5em;
	display: block;
}

.time {
	display: block;
	width: 100%;
	//min-width: 100px;
	min-height: 100px;
	font-size: 50px;
	margin: 0;
}

.score {
	font-size: 100px;
}

input[type=text], output {
	display: inline;
	max-width: 50%;
	border: inherit;
	text-align: center;
	background: inherit;
}

select {
	display: none;
}

input[type=checkbox] {
	display: block;
}

</style>
<script>
function tickTime() {
	if (localStorage.timeOut == 0) {
		localStorage.periodTime--;
	}

	if (localStorage.jamTime == 0) {
		localStorage.lineupTime++;
	} else {
		localStorage.jamTime--;
	}

	updateDisplay();
}

function startJam() {
	if (window.jamTimer) {
		
	} else {
		window.jamTimer = setInterval(tickTime, 100);
	}
	localStorage.timeOut = 0;
	localStorage.jamTime = 1200;
	localStorage.lineupTime = 0;
}

function endJam() {
	localStorage.jamTime = 0;
	localStorage.jam++;
	localStorage.lineupTime = 0;
}

function timeOut() {
	localStorage.timeOut = 1;
	localStorage.lineupTime = 0;
}

function updateTeam(t) {
	var team = document.getElementById(t);
	var teamInfo = JSON.parse(localStorage.teams)[localStorage[t]];

	team.getElementsByClassName("name")[0].value = teamInfo.name;
	team.getElementsByClassName("score")[0].value = localStorage[t + "Score"];
	team.getElementsByClassName("jammer")[0].value = localStorage[t + "Jammer"];

	var to = team.getElementsByClassName("to");
	for (var i = 0; i < to.length; i++) {
		to[i].checked = i < localStorage[t + "Timeouts"];
	}

	team.getElementsByClassName("or")[0].checked = localStorage[t + "OfficialReview"];
}

function formatTime(t) {
	var minutes = parseInt(t / 600);
	var seconds = parseInt((t - minutes * 600) / 10);
	var ds = t % 10;
	return minutes + ":" + (seconds < 10 ? "0" : "") + seconds + "." + ds;
}

function updateDisplay() {
	updateTeam("team1");
	updateTeam("team2");

	var p = document.getElementById("period");
	p.getElementsByClassName("number")[0].value = "Period " + localStorage.period;
	p.getElementsByClassName("time")[0].value = formatTime(localStorage.periodTime);

	var j = document.getElementById("jam");
	if (localStorage.jamTime > 0) {
		j.getElementsByClassName("number")[0].value = "Jam " + localStorage.jam;
		j.getElementsByClassName("time")[0].value = formatTime(localStorage.jamTime);
	} else {
		j.getElementsByClassName("number")[0].value = localStorage.timeOut == 1 ? "Timeout" : "Lineup for Jam " + localStorage.jam;
		j.getElementsByClassName("time")[0].value = formatTime(localStorage.lineupTime);
	}
}

function incPeriod() {
	localStorage.period++;
	if (localStorage.period > 2) {
		localStorage.period = 2;
	}
	updateDisplay();
}

function decPeriod() {
	localStorage.period--;
	if (localStorage.period < 1) {
		localStorage.period = 1;
	}
	updateDisplay();
}

function incJam() {
	localStorage.jam++;
	updateDisplay();
}

function decJam() {
	localStorage.jam--;
	if (localStorage.jam < 1) {
		localStorage.jam = 1;
	}
	updateDisplay();
}


function getTeam(e) {
	var id = e.id;
	while (!id) {
		e = e.parentElement;
		id = e.id;
	}
	return id;
}

function updateScore(e, n) {
	var id = getTeam(e) + "Score";
	localStorage[id] = parseInt(localStorage[id]) + parseInt(n);
	if (localStorage[id] < 0) {
		localStorage[id] = 0;
	}
	updateDisplay();
}

function resetTeam(t) {
	localStorage[t + "Score"] = 0;
	localStorage[t + "Timeouts"] = 3;
	localStorage[t + "OfficialReview"] = true;
}

function reset() {
	if (window.jamTimer) {
		clearInterval(window.jamTimer);
		window.jamTimer = undefined;
	}
	resetTeam("team1");
	resetTeam("team2");
	localStorage.team1 = 0;
	localStorage.team2 = 1;
	localStorage.period = 1;
	localStorage.jam = 1;
	localStorage.periodTime = 30 * 60 * 10;
	localStorage.jamTime = 0;
	localStorage.lineupTime = 0;
}

function updateField() {
	localStorage[this.id] = this.value;
	updateDisplay();
}

function interactiveReset() {
	if (confirm("Are you sure you want to reset the entire scoreboard?")) {
		reset();
	}
	updateDisplay();
}

function addTeamsToSelect(select) {
	var teams = JSON.parse(localStorage.teams);
	for (var i = 0; i < teams.length; i++) {
		var o = document.createElement("option");
		o.value = i;
		o.innerHTML = teams[i].name;
		o.onselect = setTeam;
		select.appendChild(o);
	}
}

function updateRoster() {
}

function addRow(roster, rowNumber, rosterNumber, rosterName) {
	var tdNumber = document.createElement("td");
	var inputNumber = document.createElement("input");
	inputNumber.id = "rosterNumber" + rowNumber;
	inputNumber.type = "text";
	inputNumber.value = rosterNumber;
	inputNumber.onchange = updateRoster;
	tdNumber.appendChild(inputNumber);

	var tdName = document.createElement("td");
	var inputName = document.createElement("input");
	inputName.id = "rosterName" + rowNumber;
	inputName.type = "text";
	inputName.value = rosterName;
	inputNumber.onchange = updateRoster;
	tdName.appendChild(inputName);

	var tr = document.createElement("tr");
	tr.appendChild(tdNumber);
	tr.appendChild(tdName);
	roster.appendChild(tr);
}

function editTeam() {
	var team = this.value ? this.value : 0;
	var teams = JSON.parse(localStorage.teams);
	var form = document.getElementById("editTeams");

	var name = document.getElementById("teamName");
	name.innerHTML = teams[team].name;
	var roster = form.getElementsByTagName("table")[0];
	roster.innerHTML = '<tr><th>#</th><th>Name</th></tr>';
	for (var i = 0; i < teams[team].players.length; i++) {
		addRow(roster, i, teams[team].players[i].number, teams[team].players[i].name);
	}
	addRow(roster, teams[team].players.length, "", "");
}

function editTeams() {
	var form = document.getElementById("editTeams");
	if (form.style.display == "block") {
		form.style.display = "none";
		return;
	}

	form.style.display = "block";
	var t = [
		{ name: "Home Team", players: [
			{ number: '1', name: 'In Your Hearts' },
			{ number: '2', name: 'The Shit' },
		] },
		{ name: "Visitor", players: [
			{ number: '10', name: 'Tenor' },
			{ number: '20', name: 'Twenty' },
		] },
	];
	localStorage.teams = JSON.stringify(t);

	var select = form.getElementsByTagName("select")[0];
	addTeamsToSelect(select);
	var add = document.createElement("option");
	add.value = "add";
	add.innerHTML = "New Team";
	select.appendChild(add);
	select.onchange = editTeam;

	editTeam();
}

function setJammers(team) {
	var teams = JSON.parse(localStorage.teams);
	var jammers = document.getElementById("team" + team + "Jammer");
	jammers.innerHTML = '';
	for (var i = 0; teams[localStorage["team" + team]].players.length; i++) {
		var o = document.createElement("option");
		o.value = teams[localStorage["team" + team]].players[i].name;
		o.innerHTML = teams[localStorage["team" + team]].players[i].number;
		jammers.appendChild(o);
	}
}

function setTeam() {
	if (this.value == "edit") {
		editTeams();
		/* set the value to whatever the last edit was */
		return;
	}
	
	var t = getTeam(this);
	localStorage[t] = this.value;
	setJammers(t);
}

function init() {
	if (!localStorage.team1) {
		reset();
	}

	if (document.location.hash == "#display") {
		var controls = document.getElementsByClassName("control");
		for (var i = 0; i < controls.length; i++) {
			controls[i].style.display = "none";
		}

		document.getElementsByTagName("body")[0].style.background = "black";
		document.getElementsByTagName("body")[0].style.color = "white";
		window.setInterval(updateDisplay, 100);
	} else {
		var inputs = document.getElementsByTagName("input");
		for (var i = 0; i < inputs.length; i++) {
			inputs[i].oninput = updateField;
			inputs[i].disabled = false;
		}

		var selects = document.getElementsByTagName("select");
		for (var i = 0; i < selects.length; i++) {
			selects[i].oninput = updateField;
			selects[i].style.display = "inline";
		}

		var displays = document.getElementsByClassName("display");
		for (var i = 0; i < displays.length; i++) {
			displays[i].style.display = "none";
		}

		var teamSelects = document.getElementsByClassName("teamSelect");
		for (var i = 0; i < teamSelects.length; i++) {
			addTeamsToSelect(teamSelects[i]);
			var edit = document.createElement("option");
			edit.value = "edit";
			edit.innerHTML = "Edit Teams";
			teamSelects[i].appendChild(edit);
			teamSelects[i].onchange = setTeam;
		}
		setJammers(1);
		setJammers(2);
	}

	updateDisplay();
}
</script>
</head>
<body onload="init();">
<div class="control">Open the <a href="#display" target="_blank">display</a> in a new window.<br></div>

<div id="team1">
	<select class="teamSelect"></select>
	<output class="display name" id="team1Name"></output><br>

	<div class="timeoutsAndScore">
		<span class="timeouts">
			<input type="checkbox" class="to" disabled>
			<input type="checkbox" class="to" disabled>
			<input type="checkbox" class="to" disabled>
			<input type="checkbox" class="or" disabled>
		</span>

		<input type="text" class="score" id="team1Score" disabled>
	</div>

	<button class="control" onclick="updateScore(this, -1)">-1</button>
	<button class="control" onclick="updateScore(this, 1)">+1</button>

	<label class="control" for="team1Jammer">Jammer: </label><select id="team1Jammer"></select>
	<output class="display jammer"></output>
</div>

<div id="team2">
	<select class="teamSelect"></select>
	<output class="display name" id="team2Name"></output>

	<div class="timeoutsAndScore">
		<input type="text" class="score" id="team2Score" disabled>

		<span class="timeouts">
			<input type="checkbox" class="to" disabled>
			<input type="checkbox" class="to" disabled>
			<input type="checkbox" class="to" disabled>
			<input type="checkbox" class="or" disabled>
		</span>
	</div>

	<span class="control">
		<button onclick="updateScore(this, -1)">-1</button>
		<button onclick="updateScore(this, 1)">+1</button>
	</span>

	<label class="control" for="team2Jammer">Jammer: </label><select id="team2Jammer"></select>
	<output class="display jammer"></output>
</div>

<div id="timing">
	<div id="period">
		<h2>
			<button class="control" onclick="decPeriod();">-</button>
			<output class="number"></output><button class="control" onclick="incPeriod();">+</button>
		</h2>
		<output type="time" class="time"></output>
	</div>

	<div id="jam">
		<h2>
			<button class="control" onclick="decJam();">-</button>
			<output class="number"></output><button class="control" onclick="incJam();">+</button>
		</h2>
		<output type="time" class="time"></output>
	</div>
</div>

<div class="control">
	<button onclick="startJam();">Start Jam</button>
	<button onclick="endJam();">End Jam</button>
	<button onclick="timeOut();">Time Out</button>
	<button onclick="interactiveReset();">Reset</button>
</div>

<div id="editTeams">
	Edit Roster For:
	<select></select>
	<button onclick="editTeams();">Done</button><br>
	<label for="name">Name: </label><input type="text" id="teamName">
	<table>
	<tr><th class="number">#</th><th class="name">Name</th></tr>
	</table>
</div>

</body>
</html>
